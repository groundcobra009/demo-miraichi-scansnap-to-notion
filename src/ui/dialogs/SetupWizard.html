<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>初期設定ウィザード</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .wizard-container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .wizard-header {
      background: #4285f4;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .wizard-header h1 {
      margin: 0;
      font-size: 20px;
    }
    .step-indicator {
      display: flex;
      justify-content: center;
      padding: 15px;
      background: #e8f0fe;
    }
    .step {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #ddd;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      font-weight: bold;
      font-size: 14px;
    }
    .step.active {
      background: #4285f4;
      color: white;
    }
    .step.completed {
      background: #34a853;
      color: white;
    }
    .wizard-content {
      padding: 25px;
      min-height: 280px;
    }
    .step-content {
      display: none;
    }
    .step-content.active {
      display: block;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .form-group input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66,133,244,0.2);
    }
    .form-group .hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .wizard-footer {
      padding: 15px 25px;
      background: #f9f9f9;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }
    .btn {
      padding: 10px 25px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .btn-primary {
      background: #4285f4;
      color: white;
    }
    .btn-primary:hover {
      background: #3367d6;
    }
    .btn-secondary {
      background: #f1f1f1;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e1e1e1;
    }
    .btn-success {
      background: #34a853;
      color: white;
    }
    .btn-success:hover {
      background: #2d9249;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .loading.show {
      display: block;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4285f4;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .message {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
      display: none;
    }
    .message.error {
      background: #fce8e6;
      color: #c5221f;
      display: block;
    }
    .message.success {
      background: #e6f4ea;
      color: #137333;
      display: block;
    }
    .step-title {
      font-size: 18px;
      color: #333;
      margin-bottom: 20px;
    }
    .step-description {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    .complete-icon {
      font-size: 60px;
      text-align: center;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="wizard-container">
    <div class="wizard-header">
      <h1>ScanSnap to Notion 初期設定</h1>
    </div>

    <div class="step-indicator">
      <div class="step active" id="step-ind-1">1</div>
      <div class="step" id="step-ind-2">2</div>
      <div class="step" id="step-ind-3">3</div>
      <div class="step" id="step-ind-4">4</div>
    </div>

    <div class="wizard-content">
      <div id="message" class="message"></div>

      <!-- Step 1: Google Drive -->
      <div class="step-content active" id="step-1">
        <div class="step-title">Step 1: Google Driveフォルダ設定</div>
        <div class="step-description">
          スキャンしたファイルが保存されているGoogle DriveフォルダのIDを入力してください。
        </div>
        <div class="form-group">
          <label for="driveFolderId">フォルダID</label>
          <input type="text" id="driveFolderId" placeholder="例: 1ABC123xyz...">
          <div class="hint">
            Google DriveフォルダのURLから取得できます。<br>
            https://drive.google.com/drive/folders/<strong>[このID]</strong>
          </div>
        </div>
      </div>

      <!-- Step 2: Notion Integration Key -->
      <div class="step-content" id="step-2">
        <div class="step-title">Step 2: Notion Integration設定</div>
        <div class="step-description">
          Notion APIを使用するためのIntegration Keyを入力してください。
        </div>
        <div class="form-group">
          <label for="notionIntegrationKey">Integration Key (Secret)</label>
          <input type="password" id="notionIntegrationKey" placeholder="secret_xxx...">
          <div class="hint">
            <a href="https://www.notion.so/my-integrations" target="_blank">Notion Integrations</a>で作成できます。
          </div>
        </div>
      </div>

      <!-- Step 3: Notion Parent ID -->
      <div class="step-content" id="step-3">
        <div class="step-title">Step 3: Notionデータベース作成先</div>
        <div class="step-description">
          データベースを作成するNotionページのIDを入力してください。
        </div>
        <div class="form-group">
          <label for="notionParentId">Parent Page ID</label>
          <input type="text" id="notionParentId" placeholder="例: abc123...">
          <div class="hint">
            NotionページのURLから取得できます。<br>
            https://www.notion.so/[ページ名]-<strong>[このID]</strong>
          </div>
        </div>
      </div>

      <!-- Step 4: Complete -->
      <div class="step-content" id="step-4">
        <div class="complete-icon">&#x2705;</div>
        <div class="step-title" style="text-align: center;">設定完了</div>
        <div class="step-description" style="text-align: center;">
          初期設定が完了しました。<br>
          「完了」ボタンを押すとNotionデータベースが作成され、<br>
          Google Driveフォルダの内容がスプレッドシートに展開されます。
        </div>
        <div id="summary" style="background: #f5f5f5; padding: 15px; border-radius: 4px; font-size: 13px;">
          <strong>設定内容:</strong><br>
          <div id="summary-content"></div>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div id="loading-message">処理中...</div>
      </div>
    </div>

    <div class="wizard-footer">
      <button class="btn btn-secondary" id="prevBtn" onclick="prevStep()" style="visibility: hidden;">戻る</button>
      <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">次へ</button>
    </div>
  </div>

  <script>
    let currentStep = 1;
    const totalSteps = 4;

    function showStep(step) {
      // Hide all steps
      for (let i = 1; i <= totalSteps; i++) {
        document.getElementById('step-' + i).classList.remove('active');
        document.getElementById('step-ind-' + i).classList.remove('active', 'completed');
      }

      // Show current step
      document.getElementById('step-' + step).classList.add('active');

      // Update indicators
      for (let i = 1; i <= totalSteps; i++) {
        if (i < step) {
          document.getElementById('step-ind-' + i).classList.add('completed');
        } else if (i === step) {
          document.getElementById('step-ind-' + i).classList.add('active');
        }
      }

      // Update buttons
      document.getElementById('prevBtn').style.visibility = step === 1 ? 'hidden' : 'visible';

      if (step === totalSteps) {
        document.getElementById('nextBtn').textContent = '完了';
        document.getElementById('nextBtn').classList.remove('btn-primary');
        document.getElementById('nextBtn').classList.add('btn-success');
        updateSummary();
      } else {
        document.getElementById('nextBtn').textContent = '次へ';
        document.getElementById('nextBtn').classList.remove('btn-success');
        document.getElementById('nextBtn').classList.add('btn-primary');
      }

      hideMessage();
    }

    function updateSummary() {
      const content = document.getElementById('summary-content');
      const driveFolderId = document.getElementById('driveFolderId').value;
      const notionParentId = document.getElementById('notionParentId').value;

      content.innerHTML = `
        <br>Google DriveフォルダID: ${driveFolderId || '(未設定)'}<br>
        Notion Integration Key: ********<br>
        Notion Parent ID: ${notionParentId || '(未設定)'}
      `;
    }

    function validateStep(step) {
      switch(step) {
        case 1:
          const driveFolderId = document.getElementById('driveFolderId').value.trim();
          if (!driveFolderId) {
            showMessage('Google DriveフォルダIDを入力してください', 'error');
            return false;
          }
          return true;
        case 2:
          const notionKey = document.getElementById('notionIntegrationKey').value.trim();
          if (!notionKey) {
            showMessage('Notion Integration Keyを入力してください', 'error');
            return false;
          }
          return true;
        case 3:
          const notionParentId = document.getElementById('notionParentId').value.trim();
          if (!notionParentId) {
            showMessage('Notion Parent IDを入力してください', 'error');
            return false;
          }
          return true;
        default:
          return true;
      }
    }

    function nextStep() {
      if (!validateStep(currentStep)) {
        return;
      }

      if (currentStep === totalSteps) {
        completeSetup();
        return;
      }

      currentStep++;
      showStep(currentStep);
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
      }
    }

    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'message ' + type;
    }

    function hideMessage() {
      document.getElementById('message').className = 'message';
    }

    function showLoading(message) {
      document.getElementById('loading').classList.add('show');
      document.getElementById('loading-message').textContent = message || '処理中...';
      document.getElementById('nextBtn').disabled = true;
      document.getElementById('prevBtn').disabled = true;
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
      document.getElementById('nextBtn').disabled = false;
      document.getElementById('prevBtn').disabled = false;
    }

    function completeSetup() {
      showLoading('設定を保存しています...');

      const settings = {
        driveFolderId: document.getElementById('driveFolderId').value.trim(),
        notionIntegrationKey: document.getElementById('notionIntegrationKey').value.trim(),
        notionParentId: document.getElementById('notionParentId').value.trim()
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showLoading('Notionデータベースを作成しています...');
            google.script.run
              .withSuccessHandler(function(dbResult) {
                if (dbResult.success) {
                  showLoading('Google Driveフォルダを読み込んでいます...');
                  google.script.run
                    .withSuccessHandler(function(driveResult) {
                      hideLoading();
                      if (driveResult.success) {
                        showMessage('設定が完了しました！ ' + driveResult.fileCount + '件のファイルを読み込みました。', 'success');
                        setTimeout(function() {
                          google.script.host.close();
                        }, 2000);
                      } else {
                        showMessage('Google Driveの読み込みに失敗: ' + driveResult.error, 'error');
                      }
                    })
                    .withFailureHandler(function(error) {
                      hideLoading();
                      showMessage('エラー: ' + error.message, 'error');
                    })
                    .loadDriveFilesToSheet();
                } else {
                  hideLoading();
                  showMessage('Notionデータベースの作成に失敗: ' + dbResult.error, 'error');
                }
              })
              .withFailureHandler(function(error) {
                hideLoading();
                showMessage('エラー: ' + error.message, 'error');
              })
              .createNotionDatabase();
          } else {
            hideLoading();
            showMessage('設定の保存に失敗: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage('エラー: ' + error.message, 'error');
        })
        .saveSetupSettings(settings);
    }

    // Load existing settings on open
    google.script.run
      .withSuccessHandler(function(settings) {
        if (settings.driveFolderId) {
          document.getElementById('driveFolderId').value = settings.driveFolderId;
        }
        if (settings.notionParentId) {
          document.getElementById('notionParentId').value = settings.notionParentId;
        }
      })
      .getCurrentSettings();
  </script>
</body>
</html>
