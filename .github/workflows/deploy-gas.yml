name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main
  workflow_dispatch: # 手動実行を許可

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # セキュリティ: package.json がない場合のために条件分岐
      - name: Install dependencies (if package.json exists)
        run: |
          if [ -f package.json ]; then
            npm ci
          fi

      - name: Install clasp globally
        run: npm install -g @google/clasp

      # セキュリティ: clasprc.json は機密情報を含むため、必ずGitHub Secretsから取得
      # CLASPRC_JSON_BASE64 には clasp login で生成される ~/.clasprc.json をbase64エンコードした内容を保存
      - name: Setup clasp credentials
        run: |
          echo "Debug: Checking CLASPRC_JSON_BASE64 secret..."
          if [ -z "${{ secrets.CLASPRC_JSON_BASE64 }}" ]; then
            echo "Error: CLASPRC_JSON_BASE64 secret is not set"
            exit 1
          fi
          echo "Debug: Decoding base64..."
          echo "${{ secrets.CLASPRC_JSON_BASE64 }}" | tr -d '\n' | base64 -d > ~/.clasprc.json
          chmod 600 ~/.clasprc.json
          echo "Debug: Validating JSON format..."
          if ! jq empty ~/.clasprc.json 2>/dev/null; then
            echo "Error: ~/.clasprc.json is not valid JSON"
            cat ~/.clasprc.json
            exit 1
          fi
          echo "✓ clasprc.json is valid"

      # セキュリティ: .clasp.json にスクリプトIDが含まれる
      # リポジトリに .clasp.json がない場合は CLASP_JSON シークレットから取得
      - name: Setup .clasp.json (if not in repo)
        run: |
          if [ ! -f .clasp.json ]; then
            echo '${{ secrets.CLASP_JSON }}' > .clasp.json
          fi

      # デプロイ前の検証（オプション）
      - name: Validate clasp configuration
        run: |
          if [ ! -f .clasp.json ]; then
            echo "Error: .clasp.json not found"
            exit 1
          fi
          echo "✓ .clasp.json found"
          echo "Debug: .clasp.json content:"
          cat .clasp.json
          echo "Debug: ~/.clasprc.json exists: $(test -f ~/.clasprc.json && echo 'yes' || echo 'no')"
          echo "✓ clasp version: $(clasp --version)"

      # GASへデプロイ
      - name: Deploy to Google Apps Script
        run: clasp push --force

      # デプロイ結果の確認（オプション）
      - name: Verify deployment
        run: |
          echo "✓ Deployment completed successfully"
          clasp version || echo "Note: clasp version command may require additional setup"

      # セキュリティ: 機密情報のクリーンアップ
      - name: Cleanup credentials
        if: always()
        run: |
          rm -f ~/.clasprc.json
          rm -f .clasp.json 2>/dev/null || true
